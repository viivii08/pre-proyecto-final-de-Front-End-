<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Favoritos - Patagonia Style</title>
  <link rel="icon" type="image/png" href="pages/logo sin fondo (1).png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      background: #f4f1ee;
      font-family: 'Poppins', sans-serif;
      color: #2b2b2b;
    }
    
    .favorites-header {
      background: linear-gradient(135deg, #1f3c5a, #3b5d50);
      color: white;
      padding: 3rem 0 2rem;
      margin-bottom: 2rem;
    }
    
    .favorites-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
      height: 100%;
    }
    
    .favorites-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .favorite-item-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 15px 15px 0 0;
    }
    
    .favorite-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .btn-favorite-action {
      flex: 1;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .empty-favorites {
      text-align: center;
      padding: 4rem 2rem;
      color: #666;
    }
    
    .empty-favorites i {
      font-size: 4rem;
      color: #ddd;
      margin-bottom: 1rem;
    }
    
    .stats-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
    }
    
    .filter-section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .favorite-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(231, 76, 60, 0.9);
      color: white;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    
    .whatsapp-float {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #25d366;
      color: #fff;
      font-size: 2.2rem;
      padding: 12px 16px;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 999;
      transition: background 0.2s;
      text-align: center;
    }
    
    .whatsapp-float:hover {
      background: #1ebe57;
      color: #fff;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <div id="navbar-container"></div>

  <!-- Header -->
  <section class="favorites-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="mb-2">
            <i class="bi bi-heart-fill me-3" style="color: #e74c3c;"></i>
            Mis Favoritos
          </h1>
          <p class="mb-0 opacity-75">Tus productos favoritos de Patagonia Style</p>
        </div>
        <div class="col-md-4 text-md-end">
          <div class="d-flex justify-content-md-end justify-content-start gap-2 mt-3 mt-md-0">
            <button class="btn btn-outline-light" onclick="clearAllFavorites()">
              <i class="bi bi-trash me-2"></i>Limpiar todo
            </button>
            <button class="btn btn-warning" onclick="shareWishlist()">
              <i class="bi bi-share me-2"></i>Compartir
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Stats -->
  <div class="container">
    <div class="stats-card">
      <div class="row text-center">
        <div class="col-md-3 col-6">
          <h3 class="text-primary mb-1" id="total-favorites">0</h3>
          <small class="text-muted">Productos favoritos</small>
        </div>
        <div class="col-md-3 col-6">
          <h3 class="text-success mb-1" id="total-value">$0</h3>
          <small class="text-muted">Valor total</small>
        </div>
        <div class="col-md-3 col-6">
          <h3 class="text-info mb-1" id="recent-favorites">0</h3>
          <small class="text-muted">Esta semana</small>
        </div>
        <div class="col-md-3 col-6">
          <h3 class="text-warning mb-1" id="avg-price">$0</h3>
          <small class="text-muted">Precio promedio</small>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filter-section">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h5 class="mb-0">Filtrar y ordenar</h5>
        </div>
        <div class="col-md-6">
          <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="sort-favorites">
              <option value="newest">Más recientes</option>
              <option value="oldest">Más antiguos</option>
              <option value="name">Por nombre</option>
              <option value="price-low">Precio: menor a mayor</option>
              <option value="price-high">Precio: mayor a menor</option>
            </select>
            <button class="btn btn-outline-secondary btn-sm" onclick="refreshFavorites()">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Favorites Grid -->
    <div id="favorites-container">
      <!-- Se carga dinámicamente -->
    </div>

    <!-- Empty State -->
    <div id="empty-favorites" class="empty-favorites" style="display: none;">
      <i class="bi bi-heart"></i>
      <h3>No tienes favoritos aún</h3>
      <p>Explora nuestra tienda y agrega productos a tu lista de favoritos</p>
      <a href="tienda.html" class="btn btn-primary btn-lg">
        <i class="bi bi-shop me-2"></i>Explorar Tienda
      </a>
    </div>
  </div>

  <!-- Footer -->
  <footer style="background: linear-gradient(90deg, #1f3c5a, #3b5d50); color: white; text-align: center; padding: 40px 0; margin-top: 50px;">
    <div class="container">
      <p>&copy; 2025 Patagonia Style - Todos los derechos reservados</p>
      <p>Creado por Vargas Viviana</p>
      <div>
        <a href="#" style="color: #b67c3a; text-decoration: none; margin: 0 15px;">Instagram</a>
        <a href="#" style="color: #b67c3a; text-decoration: none; margin: 0 15px;">Facebook</a>
      </div>
      <div style="margin-top: 15px;">
        <div>
          <a href="mailto:info@patagoniastyle.com" style="color: #666; text-decoration: underline; margin: 0 15px;">info@patagoniastyle.com</a>
          <a href="tel:+5411136899678" style="color: #666; text-decoration: underline; margin: 0 15px;">+54 11 3689-9678</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- WhatsApp Float -->
  <a href="https://wa.me/5491136899678" class="whatsapp-float" target="_blank" title="¡Escríbenos por WhatsApp!">
    <i class="bi bi-whatsapp"></i>
  </a>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/store.js"></script>
  <script src="js/users.js"></script>
  <script src="js/navigation.js"></script>
  <script src="js/favorites.js"></script>

  <script>
    // Funciones específicas de la página de favoritos
    let currentSort = 'newest';

    document.addEventListener('DOMContentLoaded', function() {
      // Renderizar navbar
      document.getElementById('navbar-container').innerHTML = navigationComponent.renderNavbar();
      navigationComponent.init();
      
      // Cargar favoritos
      loadFavoritesPage();
      
      // Escuchar cambios en favoritos
      window.addEventListener('favoritesUpdated', loadFavoritesPage);
      
      // Escuchar cambios en el ordenamiento
      document.getElementById('sort-favorites').addEventListener('change', function() {
        currentSort = this.value;
        renderFavorites();
      });
    });

    function loadFavoritesPage() {
      updateStats();
      renderFavorites();
    }

    function updateStats() {
      const favorites = favoritesManager.getFavorites();
      const now = new Date();
      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      // Contar favoritos recientes
      const recentFavorites = favorites.filter(fav => 
        new Date(fav.addedAt) > weekAgo
      ).length;
      
      // Calcular valores
      const totalValue = favorites.reduce((sum, fav) => {
        const price = parseFloat(fav.price.replace(/[^0-9.-]+/g, '')) || 0;
        return sum + price;
      }, 0);
      
      const avgPrice = favorites.length > 0 ? totalValue / favorites.length : 0;
      
      // Actualizar interfaz
      document.getElementById('total-favorites').textContent = favorites.length;
      document.getElementById('total-value').textContent = formatPrice(totalValue);
      document.getElementById('recent-favorites').textContent = recentFavorites;
      document.getElementById('avg-price').textContent = formatPrice(avgPrice);
    }

    function renderFavorites() {
      const favorites = favoritesManager.getFavorites();
      const container = document.getElementById('favorites-container');
      const emptyState = document.getElementById('empty-favorites');
      
      if (favorites.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      // Ordenar favoritos
      const sortedFavorites = sortFavorites(favorites, currentSort);
      
      container.innerHTML = `
        <div class="row">
          ${sortedFavorites.map(favorite => `
            <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
              <div class="favorites-card">
                <div class="position-relative">
                  <img src="${favorite.image}" alt="${favorite.name}" class="favorite-item-img">
                  <div class="favorite-badge">
                    <i class="bi bi-heart-fill"></i>
                  </div>
                </div>
                <div class="p-3">
                  <h6 class="fw-bold mb-2">${favorite.name}</h6>
                  <p class="text-success fw-bold mb-2">${favorite.price}</p>
                  <small class="text-muted d-block mb-2">
                    Agregado ${formatDate(favorite.addedAt)}
                  </small>
                  <div class="favorite-actions">
                    <button class="btn btn-primary btn-favorite-action" 
                            onclick="addToCartFromFavorites('${favorite.id}', '${favorite.name}', '${favorite.price}')">
                      <i class="bi bi-cart-plus"></i> Carrito
                    </button>
                    <button class="btn btn-outline-secondary btn-favorite-action" 
                            onclick="viewProduct('${favorite.url}')">
                      <i class="bi bi-eye"></i> Ver
                    </button>
                    <button class="btn btn-outline-danger btn-favorite-action" 
                            onclick="removeFromFavorites('${favorite.id}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function sortFavorites(favorites, sortBy) {
      const sorted = [...favorites];
      
      switch (sortBy) {
        case 'newest':
          return sorted.sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt));
        case 'oldest':
          return sorted.sort((a, b) => new Date(a.addedAt) - new Date(b.addedAt));
        case 'name':
          return sorted.sort((a, b) => a.name.localeCompare(b.name));
        case 'price-low':
          return sorted.sort((a, b) => parsePrice(a.price) - parsePrice(b.price));
        case 'price-high':
          return sorted.sort((a, b) => parsePrice(b.price) - parsePrice(a.price));
        default:
          return sorted;
      }
    }

    function parsePrice(priceStr) {
      return parseFloat(priceStr.replace(/[^0-9.-]+/g, '')) || 0;
    }

    function formatPrice(price) {
      return new Intl.NumberFormat('es-AR', {
        style: 'currency',
        currency: 'ARS',
        minimumFractionDigits: 0
      }).format(price);
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 1) return 'hoy';
      if (diffDays === 2) return 'ayer';
      if (diffDays <= 7) return `hace ${diffDays} días`;
      
      return date.toLocaleDateString('es-AR');
    }

    function addToCartFromFavorites(productId, name, price) {
      // Simular agregar al carrito
      if (typeof store !== 'undefined' && store.agregarAlCarrito) {
        const producto = {
          id: productId,
          nombre: name,
          precio: parsePrice(price),
          imagen: 'pages/logo sin fondo (1).png',
          cantidad: 1
        };
        store.agregarAlCarrito(producto);
      } else {
        alert(`${name} agregado al carrito`);
      }
    }

    function viewProduct(url) {
      window.location.href = url;
    }

    function removeFromFavorites(productId) {
      if (confirm('¿Estás seguro de que quieres quitar este producto de favoritos?')) {
        favoritesManager.removeFromFavorites(productId);
      }
    }

    function clearAllFavorites() {
      if (confirm('¿Estás seguro de que quieres eliminar todos los favoritos?')) {
        favoritesManager.clearFavorites();
      }
    }

    function refreshFavorites() {
      loadFavoritesPage();
    }

    function shareWishlist() {
      const favorites = favoritesManager.getFavorites();
      if (favorites.length === 0) {
        alert('No tienes productos en favoritos para compartir');
        return;
      }
      
      const favoriteNames = favorites.map(fav => fav.name).join(', ');
      const text = `Mira mis productos favoritos de Patagonia Style: ${favoriteNames}`;
      const url = window.location.origin + '/mis-favoritos.html';
      
      if (navigator.share) {
        navigator.share({
          title: 'Mis favoritos - Patagonia Style',
          text: text,
          url: url
        });
      } else {
        // Fallback para navegadores que no soportan Web Share API
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`;
        window.open(whatsappUrl, '_blank');
      }
    }
  </script>
</body>
</html>