<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - Patagonia Style</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navbar -->
    <div id="navbar-container"></div>

    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <h2><i class="bi bi-cart-check me-2"></i>Finalizar Compra</h2>
                <hr>
            </div>
        </div>

        <div class="row">
            <!-- Resumen del pedido -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-list-check me-2"></i>Resumen del Pedido</h5>
                    </div>
                    <div class="card-body">
                        <div id="checkout-items">
                            <!-- Los items se cargar√°n aqu√≠ -->
                        </div>
                        
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-6">
                                    <strong>Subtotal:</strong>
                                </div>
                                <div class="col-6 text-end">
                                    <span id="checkout-subtotal">$0.00</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <strong>Env√≠o:</strong>
                                </div>
                                <div class="col-6 text-end">
                                    <span>Gratis</span>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-6">
                                    <h5><strong>Total:</strong></h5>
                                </div>
                                <div class="col-6 text-end">
                                    <h5><strong id="checkout-total">$0.00</strong></h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n del cliente -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-person me-2"></i>Informaci√≥n de Contacto</h5>
                    </div>
                    <div class="card-body">
                        <form id="checkout-form">
                            <div class="mb-3">
                                <label for="customer-name" class="form-label">Nombre completo</label>
                                <input type="text" class="form-control" id="customer-name" required>
                            </div>
                            <div class="mb-3">
                                <label for="customer-email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="customer-email" required>
                            </div>
                            <div class="mb-3">
                                <label for="customer-phone" class="form-label">Tel√©fono</label>
                                <input type="tel" class="form-control" id="customer-phone" required>
                            </div>
                            <div class="mb-3">
                                <label for="customer-address" class="form-label">Direcci√≥n</label>
                                <textarea class="form-control" id="customer-address" rows="3" required></textarea>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success btn-lg" id="confirm-order-btn">
                                    <i class="bi bi-whatsapp me-2"></i>
                                    Confirmar Pedido por WhatsApp
                                </button>
                                <a href="carrito.html" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-2"></i>
                                    Volver al Carrito
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/error-protection.js"></script>
    <script src="js/simple-whatsapp.js"></script>
    <script src="js/whatsapp-checkout.js"></script>
    <script src="js/universal-navbar.js?v=3"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar navbar
            new UniversalNavbar('navbar-container', {
                showSearch: false
            });

            // Cargar items del carrito
            loadCheckoutItems();

            // Configurar bot√≥n de confirmar
            document.getElementById('confirm-order-btn').addEventListener('click', confirmOrder);
        });

        function loadCheckoutItems() {
            const cart = JSON.parse(localStorage.getItem('cart')) || 
                        JSON.parse(localStorage.getItem('carrito')) || [];
            
            const container = document.getElementById('checkout-items');
            const subtotalEl = document.getElementById('checkout-subtotal');
            const totalEl = document.getElementById('checkout-total');

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-4">
                        <i class="bi bi-cart-x display-4 text-muted"></i>
                        <p class="text-muted mt-2">No hay productos en el carrito</p>
                        <a href="tienda.html" class="btn btn-primary">Ir a la Tienda</a>
                    </div>
                `;
                return;
            }

            let subtotal = 0;
            let html = '';

            cart.forEach(item => {
                const price = item.price || item.precio || 0;
                const quantity = item.quantity || item.cantidad || 1;
                const name = item.name || item.nombre || 'Producto';
                const image = item.image || item.img || 'https://via.placeholder.com/50';
                const itemTotal = price * quantity;
                subtotal += itemTotal;

                html += `
                    <div class="row align-items-center mb-3 pb-3 border-bottom">
                        <div class="col-2">
                            <img src="${image}" alt="${name}" class="img-fluid rounded" style="width: 50px; height: 50px; object-fit: cover;">
                        </div>
                        <div class="col-6">
                            <h6 class="mb-1">${name}</h6>
                            <small class="text-muted">Cantidad: ${quantity}</small>
                        </div>
                        <div class="col-4 text-end">
                            <span class="fw-bold">$${itemTotal.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            totalEl.textContent = `$${subtotal.toFixed(2)}`;
        }

        function confirmOrder() {
            const form = document.getElementById('checkout-form');
            const formData = new FormData(form);
            
            // Validar formulario
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const cart = JSON.parse(localStorage.getItem('cart')) || 
                        JSON.parse(localStorage.getItem('carrito')) || [];
            
            if (cart.length === 0) {
                alert('El carrito est√° vac√≠o');
                return;
            }

            // Crear mensaje para WhatsApp
            const customerName = document.getElementById('customer-name').value;
            const customerEmail = document.getElementById('customer-email').value;
            const customerPhone = document.getElementById('customer-phone').value;
            const customerAddress = document.getElementById('customer-address').value;

            let mensaje = `¬°Hola! Quiero confirmar mi pedido:%0A%0A`;
            mensaje += `üë§ *Cliente:* ${customerName}%0A`;
            mensaje += `üìß *Email:* ${customerEmail}%0A`;
            mensaje += `üì± *Tel√©fono:* ${customerPhone}%0A`;
            mensaje += `üìç *Direcci√≥n:* ${customerAddress}%0A%0A`;
            mensaje += `üõçÔ∏è *Productos:*%0A`;

            let total = 0;
            cart.forEach(item => {
                const price = item.price || item.precio || 0;
                const quantity = item.quantity || item.cantidad || 1;
                const name = item.name || item.nombre || 'Producto';
                const itemTotal = price * quantity;
                total += itemTotal;
                mensaje += `‚Ä¢ ${name} (x${quantity}) - $${itemTotal.toFixed(2)}%0A`;
            });

            mensaje += `%0Aüí∞ *Total: $${total.toFixed(2)}*%0A%0A`;
            mensaje += `¬°Esperando la confirmaci√≥n! üòä`;

            // Limpiar carrito
            localStorage.removeItem('cart');
            localStorage.removeItem('carrito');

            // Abrir WhatsApp
            window.open(`https://wa.me/5491136899678?text=${mensaje}`, '_blank');

            // Mostrar mensaje de √©xito y redirigir
            setTimeout(() => {
                alert('¬°Pedido enviado! Te contactaremos pronto.');
                window.location.href = 'index.html';
            }, 1000);
        }
    </script>
</body>
</html>