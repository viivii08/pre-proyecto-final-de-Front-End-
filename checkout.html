<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - Patagonia Style</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="navbar-container"></div>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <h2><i class="bi bi-cart-check me-2"></i>Finalizar Compra</h2>
                <hr>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-list-check me-2"></i>Resumen del Pedido</h5>
                    </div>
                    <div class="card-body">
                        <div id="checkout-items">
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-credit-card me-2"></i>M√©todo de Pago</h5>
                    </div>
                    <div class="card-body">
                        <div class="payment-methods">
                            <div class="form-check mb-3 p-3 border rounded">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="transferencia" value="transferencia" checked>
                                <label class="form-check-label w-100" for="transferencia">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-bank me-2 text-success"></i>
                                            <strong>Transferencia Bancaria</strong>
                                            <br><small class="text-muted">10% de descuento</small>
                                        </div>
                                        <div class="badge bg-success">-10%</div>
                                    </div>
                                </label>
                            </div>
                            <div class="form-check mb-3 p-3 border rounded">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="mercadopago" value="mercadopago">
                                <label class="form-check-label w-100" for="mercadopago">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-credit-card me-2 text-primary"></i>
                                            <strong>MercadoPago</strong>
                                            <br><small class="text-muted">Tarjetas de cr√©dito/d√©bito</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="form-check mb-3 p-3 border rounded">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="efectivo" value="efectivo">
                                <label class="form-check-label w-100" for="efectivo">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-cash me-2 text-warning"></i>
                                            <strong>Efectivo</strong>
                                            <br><small class="text-muted">Pago contra entrega</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-person me-2"></i>Informaci√≥n de Contacto</h5>
                    </div>
                    <div class="card-body">
                        <form id="checkout-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="customer-name" class="form-label">Nombre completo *</label>
                                    <input type="text" class="form-control" id="customer-name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="customer-email" class="form-label">Email *</label>
                                    <input type="email" class="form-control" id="customer-email" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="customer-phone" class="form-label">Tel√©fono *</label>
                                <input type="tel" class="form-control" id="customer-phone" required>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-truck me-2"></i>Opciones de Env√≠o</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="provincia" class="form-label">Provincia *</label>
                            <select class="form-select" id="provincia" required onchange="calcularEnvio()">
                                <option value="">Seleccionar provincia</option>
                                <option value="caba">CABA</option>
                                <option value="bsas">Buenos Aires</option>
                                <option value="cordoba">C√≥rdoba</option>
                                <option value="santa-fe">Santa Fe</option>
                                <option value="mendoza">Mendoza</option>
                                <option value="tucuman">Tucum√°n</option>
                                <option value="entre-rios">Entre R√≠os</option>
                                <option value="salta">Salta</option>
                                <option value="other">Otra provincia</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="customer-address" class="form-label">Direcci√≥n completa *</label>
                            <textarea class="form-control" id="customer-address" rows="3" required 
                                      placeholder="Calle, n√∫mero, piso, departamento, c√≥digo postal, localidad"></textarea>
                        </div>
                        <div class="shipping-options" id="shipping-options" style="display: none;">
                            <h6 class="mb-3">Selecciona el tipo de env√≠o:</h6>
                            <div class="form-check mb-3 p-3 border rounded">
                                <input class="form-check-input" type="radio" name="shippingMethod" id="standard" value="standard">
                                <label class="form-check-label w-100" for="standard">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>Env√≠o Est√°ndar</strong>
                                            <br><small class="text-muted" id="standard-time">5-7 d√≠as h√°biles</small>
                                        </div>
                                        <div>
                                            <span class="fw-bold" id="standard-price">$12.000</span>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="form-check mb-3 p-3 border rounded">
                                <input class="form-check-input" type="radio" name="shippingMethod" id="express" value="express">
                                <label class="form-check-label w-100" for="express">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>Env√≠o Express</strong>
                                            <br><small class="text-muted" id="express-time">1-3 d√≠as h√°biles</small>
                                        </div>
                                        <div>
                                            <span class="fw-bold" id="express-price">$18.000</span>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="alert alert-info mt-3" id="free-shipping-alert" style="display: none;">
                                <i class="bi bi-truck me-2"></i>
                                <strong>¬°Env√≠o gratis!</strong> Tu compra califica para env√≠o gratuito.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-calculator me-2"></i>Resumen Final</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-8">Subtotal:</div>
                            <div class="col-4 text-end" id="checkout-subtotal">$0.00</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-8">Env√≠o:</div>
                            <div class="col-4 text-end" id="checkout-shipping">$0</div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-8"><h5><strong>Total:</strong></h5></div>
                            <div class="col-4 text-end"><h5><strong id="checkout-total">$0.00</strong></h5></div>
                        </div>
                        <div class="d-grid gap-2 mt-4">
                            <button type="button" class="btn btn-success btn-lg" id="confirm-order-btn">
                                <i class="bi bi-whatsapp me-2"></i>
                                Confirmar Pedido por WhatsApp
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
                                <i class="bi bi-arrow-left me-2"></i>
                                Volver
                            </button>
                        </div>
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                <i class="bi bi-shield-check me-1"></i>
                                Pago 100% seguro
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/error-protection.js"></script>
    <script src="js/simple-whatsapp.js"></script>
    <script src="js/whatsapp-checkout.js"></script>
    <script src="js/universal-navbar.js?v=3"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando p√°gina de checkout...');
            // Inicializar navbar
            new UniversalNavbar('navbar-container', {
                showSearch: false
            });
            // Cargar items del carrito inmediatamente
            loadCheckoutItems();
            // Configurar bot√≥n de confirmar
            document.getElementById('confirm-order-btn').addEventListener('click', confirmOrder);
            console.log('‚úÖ Checkout inicializado correctamente');
        });
        function loadCheckoutItems() {
            console.log('üõí Cargando productos del carrito en checkout...');
            // Debug: verificar todas las keys del localStorage
            console.log('üîç Contenido de localStorage:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                console.log(`  ${key}:`, value);
            }
            // Solo usar 'carrito' como key para consistencia
            const cart = JSON.parse(localStorage.getItem('carrito') || '[]');
            console.log('üì¶ Productos encontrados en carrito:', cart);
            console.log('üìä Cantidad de productos:', cart.length);
            const container = document.getElementById('checkout-items');
            const subtotalEl = document.getElementById('checkout-subtotal');
            const totalEl = document.getElementById('checkout-total');
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-4">
                        <i class="bi bi-cart-x display-4 text-muted"></i>
                        <p class="text-muted mt-2">No hay productos en el carrito</p>
                        <a href="tienda.html" class="btn btn-primary">Ir a la Tienda</a>
                    </div>
                `;
                subtotalEl.textContent = '$0.00';
                totalEl.textContent = '$0.00';
                return;
            }
            let subtotal = 0;
            let html = '';
            cart.forEach(item => {
                const price = item.precio || 0; // Usar solo 'precio'
                const quantity = item.cantidad || 1; // Usar solo 'cantidad'
                const name = item.nombre || 'Producto'; // Usar solo 'nombre'
                const image = item.imagen || 'pages/logo sin fondo (1).png'; // Usar solo 'imagen'
                const itemTotal = price * quantity;
                subtotal += itemTotal;
                html += `
                    <div class="row align-items-center mb-3 pb-3 border-bottom">
                        <div class="col-2">
                            <img src="${image}" alt="${name}" class="img-fluid rounded" style="width: 60px; height: 60px; object-fit: cover;">
                        </div>
                        <div class="col-6">
                            <h6 class="mb-1">${name}</h6>
                            <small class="text-muted">Cantidad: ${quantity} | Precio unitario: $${price.toLocaleString()}</small>
                        </div>
                        <div class="col-4 text-end">
                            <span class="fw-bold">$${itemTotal.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            // Guardar subtotal para c√°lculos posteriores
            window.checkoutSubtotal = subtotal;
            subtotalEl.textContent = `$${subtotal.toLocaleString()}`;
            // Calcular total inicial
            calculateTotals();
            console.log('‚úÖ Productos cargados correctamente. Total:', subtotal);
        }
        // Funci√≥n para calcular env√≠o basado en provincia
        function calcularEnvio() {
            const provincia = document.getElementById('provincia').value;
            const shippingOptions = document.getElementById('shipping-options');
            const standardPrice = document.getElementById('standard-price');
            const expressPrice = document.getElementById('express-price');
            const standardTime = document.getElementById('standard-time');
            const expressTime = document.getElementById('express-time');
            const freeShippingAlert = document.getElementById('free-shipping-alert');
            if (!provincia) {
                shippingOptions.style.display = 'none';
                return;
            }
            let standardCost = 0;
            let expressCost = 0;
            let standardTimeText = '';
            let expressTimeText = '';
            let freeShippingLimit = 0;
            if (provincia === 'caba' || provincia === 'bsas') {
                standardCost = 8500;
                expressCost = 12000;
                standardTimeText = '3-5 d√≠as h√°biles';
                expressTimeText = '1-2 d√≠as h√°biles';
                freeShippingLimit = 50000;
            } else {
                standardCost = 12000;
                expressCost = 18000;
                standardTimeText = '5-7 d√≠as h√°biles';
                expressTimeText = '2-4 d√≠as h√°biles';
                freeShippingLimit = 75000;
            }
            // Verificar si califica para env√≠o gratis
            const subtotal = window.checkoutSubtotal || 0;
            const qualifiesForFreeShipping = subtotal >= freeShippingLimit;
            if (qualifiesForFreeShipping) {
                standardCost = 0;
                expressCost = Math.max(0, expressCost - standardCost);
                freeShippingAlert.style.display = 'block';
            } else {
                freeShippingAlert.style.display = 'none';
            }
            standardPrice.textContent = standardCost > 0 ? `$${standardCost.toLocaleString()}` : 'Gratis';
            expressPrice.textContent = expressCost > 0 ? `$${expressCost.toLocaleString()}` : 'Gratis';
            standardTime.textContent = standardTimeText;
            expressTime.textContent = expressTimeText;
            // Seleccionar env√≠o est√°ndar por defecto
            document.getElementById('standard').checked = true;
            shippingOptions.style.display = 'block';
            calculateTotals();
        }
        // Funci√≥n para calcular totales
        function calculateTotals() {
            const subtotal = window.checkoutSubtotal || 0;
            const subtotalEl = document.getElementById('checkout-subtotal');
            const shippingEl = document.getElementById('checkout-shipping');
            const totalEl = document.getElementById('checkout-total');
            // Calcular costo de env√≠o
            let shippingCost = 0;
            const shippingMethod = document.querySelector('input[name="shippingMethod"]:checked')?.value;
            if (shippingMethod) {
                const shippingPriceText = document.getElementById(shippingMethod + '-price').textContent;
                if (shippingPriceText !== 'Gratis') {
                    shippingCost = parseInt(shippingPriceText.replace('$', '').replace('.', '').replace(',', ''));
                }
            }
            shippingEl.textContent = `$${shippingCost.toLocaleString()}`;
            const total = subtotal + shippingCost;
            subtotalEl.textContent = `$${subtotal.toLocaleString()}`;
            totalEl.textContent = `$${total.toLocaleString()}`;
            // Guardar para usar en confirmaci√≥n
            window.checkoutTotal = total;
            window.checkoutShipping = shippingCost;
            window.checkoutShipping = shippingCost;
        }
        // Event listeners para recalcular totales
        document.addEventListener('change', function(e) {
            if (e.target.name === 'paymentMethod' || e.target.name === 'shippingMethod') {
                calculateTotals();
            }
        });
        function confirmOrder() {
            const form = document.getElementById('checkout-form');
            // Validar formulario b√°sico
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                alert('Por favor completa todos los campos requeridos');
                return;
            }
            // Validaciones adicionales
            const provincia = document.getElementById('provincia').value;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
            const shippingMethod = document.querySelector('input[name="shippingMethod"]:checked')?.value;
            if (!provincia) {
                alert('Por favor selecciona una provincia');
                return;
            }
            if (provincia !== '' && !shippingMethod) {
                alert('Por favor selecciona un m√©todo de env√≠o');
                return;
            }
            const cart = JSON.parse(localStorage.getItem('carrito') || '[]');
            if (cart.length === 0) {
                alert('El carrito est√° vac√≠o');
                return;
            }
            // Obtener datos del formulario
            const customerName = document.getElementById('customer-name').value;
            const customerEmail = document.getElementById('customer-email').value;
            const customerPhone = document.getElementById('customer-phone').value;
            const customerAddress = document.getElementById('customer-address').value;
            // Obtener informaci√≥n de pago y env√≠o
            const paymentMethods = {
                'transferencia': 'Transferencia Bancaria (10% desc.)',
                'mercadopago': 'MercadoPago',
                'efectivo': 'Efectivo contra entrega'
            };
            const shippingMethods = {
                'standard': 'Env√≠o Est√°ndar',
                'express': 'Env√≠o Express'
            };
            const paymentText = paymentMethods[paymentMethod] || paymentMethod;
            const shippingText = shippingMethods[shippingMethod] || shippingMethod;
            const shippingPrice = document.getElementById(shippingMethod + '-price').textContent;
            const shippingTime = document.getElementById(shippingMethod + '-time').textContent;
            // Crear mensaje para WhatsApp
            let mensaje = `üõçÔ∏è *NUEVO PEDIDO - PATAGONIA STYLE*%0A%0A`;
            mensaje += `üë§ *DATOS DEL CLIENTE*%0A`;
            mensaje += `‚Ä¢ Nombre: ${customerName}%0A`;
            mensaje += `‚Ä¢ Email: ${customerEmail}%0A`;
            mensaje += `‚Ä¢ Tel√©fono: ${customerPhone}%0A`;
            mensaje += `‚Ä¢ Direcci√≥n: ${customerAddress}%0A`;
            mensaje += `‚Ä¢ Provincia: ${provincia.toUpperCase()}%0A%0A`;
            mensaje += `üì¶ *PRODUCTOS SOLICITADOS*%0A`;
            let subtotal = 0;
            cart.forEach(item => {
                const price = item.precio || 0;
                const quantity = item.cantidad || 1;
                const name = item.nombre || 'Producto';
                const itemTotal = price * quantity;
                subtotal += itemTotal;
                mensaje += `‚Ä¢ ${name}%0A`;
                mensaje += `  Cantidad: ${quantity} x $${price.toLocaleString()} = $${itemTotal.toLocaleString()}%0A`;
            });
            mensaje += `%0AÔøΩ *M√âTODO DE PAGO*%0A`;
            mensaje += `‚Ä¢ ${paymentText}%0A%0A`;
            mensaje += `üöö *ENV√çO*%0A`;
            mensaje += `‚Ä¢ M√©todo: ${shippingText}%0A`;
            mensaje += `‚Ä¢ Tiempo: ${shippingTime}%0A`;
            mensaje += `‚Ä¢ Costo: ${shippingPrice}%0A%0A`;
            mensaje += ` *RESUMEN FINANCIERO*%0A`;
            mensaje += `‚Ä¢ Subtotal: $${subtotal.toLocaleString()}%0A`;
            mensaje += `‚Ä¢ Env√≠o: $${window.checkoutShipping.toLocaleString()}%0A`;
            mensaje += `‚Ä¢ *TOTAL: $${window.checkoutTotal.toLocaleString()}*%0A%0A`;
            if (paymentMethod === 'transferencia') {
                mensaje += `üè¶ *DATOS PARA TRANSFERENCIA*%0A`;
                mensaje += `‚Ä¢ Banco: Banco Naci√≥n%0A`;
                mensaje += `‚Ä¢ CBU: 0110599520000012345678%0A`;
                mensaje += `‚Ä¢ Alias: PATAGONIA.STYLE%0A`;
                mensaje += `‚Ä¢ Titular: Patagonia Style%0A%0A`;
            }
            mensaje += `üìû *¬°Esperamos tu confirmaci√≥n!*%0A`;
            mensaje += `Nos pondremos en contacto contigo para coordinar el pago y env√≠o.%0A%0A`;
            mensaje += `‚ú® ¬°Gracias por elegirnos! ‚ú®`;
            // Abrir WhatsApp
            const whatsappUrl = `https://wa.me/5491136899678?text=${mensaje}`;
            console.log('üì± Abriendo WhatsApp con mensaje:', mensaje);
            window.open(whatsappUrl, '_blank');
            // Limpiar carrito despu√©s de enviar
            localStorage.removeItem('carrito');
            // Mostrar mensaje de √©xito y redirigir
            setTimeout(() => {
                alert('¬°Pedido enviado! Te contactaremos pronto por WhatsApp.');
                window.location.href = 'tienda.html';
            }, 2000);
        }
    </script>
  <script src="js/whatsapp-global.js"></script>
</body>
</html>