<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ¨ Demo - Sistema Avanzado de LocalStorage y Formularios DinÃ¡micos</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #f4f1ee;
            transition: all 0.3s ease;
        }

        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .demo-header {
            background: linear-gradient(135deg, #3b5d50, #2d4a40);
            color: white;
            padding: 3rem 2rem;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .demo-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #3b5d50;
            box-shadow: 0 0 0 0.25rem rgba(59, 93, 80, 0.1);
        }

        .btn {
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b5d50, #4a7c59);
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 93, 80, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .cart-preview {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #dee2e6;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .update-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            z-index: 9999;
        }

        .update-feedback.show {
            opacity: 1;
            transform: translateX(0);
        }

        .is-invalid {
            border-color: #dc3545 !important;
            animation: shake 0.5s ease-in-out;
        }

        .is-valid {
            border-color: #28a745 !important;
        }

        .field-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .theme-dark {
            background-color: #2c3e50 !important;
            color: #ecf0f1;
        }

        .theme-dark .demo-section {
            background-color: #34495e;
            color: #ecf0f1;
        }

        .theme-dark .form-control,
        .theme-dark .form-select {
            background-color: #2c3e50;
            border-color: #4a4a4a;
            color: #ecf0f1;
        }

        .theme-dark .form-control:focus,
        .theme-dark .form-select:focus {
            background-color: #2c3e50;
            border-color: #3b5d50;
            color: #ecf0f1;
        }

        .demo-log {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }

        .log-timestamp {
            color: #718096;
        }

        .log-success { color: #68d391; }
        .log-warning { color: #f6e05e; }
        .log-error { color: #fc8181; }
        .log-info { color: #63b3ed; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="demo-container">
        <header class="demo-header">
            <h1><i class="bi bi-gear-fill me-3"></i>Sistema Avanzado de LocalStorage</h1>
            <p class="lead mb-0">Formularios dinÃ¡micos con validaciÃ³n en tiempo real y persistencia inteligente</p>
            <div class="mt-3">
                <span class="badge bg-light text-dark me-2">ðŸ’¾ Storage Seguro</span>
                <span class="badge bg-light text-dark me-2">âš¡ Tiempo Real</span>
                <span class="badge bg-light text-dark me-2">âœ… ValidaciÃ³n</span>
                <span class="badge bg-light text-dark">ðŸ“± Responsive</span>
            </div>
        </header>

        <!-- EstadÃ­sticas -->
        <section class="demo-section">
            <h3><i class="bi bi-bar-chart me-2"></i>EstadÃ­sticas del Sistema</h3>
            <div class="stats-grid" id="statsGrid">
                <!-- Se llenan dinÃ¡micamente -->
            </div>
        </section>

        <!-- Formulario de Preferencias -->
        <section class="demo-section">
            <h3><i class="bi bi-palette me-2"></i>Preferencias de Usuario</h3>
            <p class="text-muted mb-4">Todos los cambios se aplican en tiempo real y se guardan automÃ¡ticamente</p>
            
            <form id="preferences-form" data-dynamic-form="true" data-auto-save="true" data-real-time="true">
                <div class="row">
                    <!-- Color de Fondo -->
                    <div class="col-md-6 mb-3">
                        <label for="backgroundColor" class="form-label">
                            <i class="bi bi-palette me-1"></i>Color de Fondo
                        </label>
                        <input type="color" 
                               class="form-control form-control-color" 
                               id="backgroundColor" 
                               name="backgroundColor" 
                               value="#f4f1ee"
                               data-updater="backgroundColor" 
                               data-dynamic-update="true">
                        <small class="form-text text-muted">El color se aplica inmediatamente</small>
                    </div>

                    <!-- Tema -->
                    <div class="col-md-6 mb-3">
                        <label for="theme" class="form-label">
                            <i class="bi bi-moon me-1"></i>Tema
                        </label>
                        <select class="form-select" 
                                id="theme" 
                                name="theme"
                                data-updater="theme" 
                                data-dynamic-update="true">
                            <option value="light">ðŸŒž Claro</option>
                            <option value="dark">ðŸŒ™ Oscuro</option>
                            <option value="auto">ðŸ”„ AutomÃ¡tico</option>
                        </select>
                    </div>

                    <!-- Notificaciones -->
                    <div class="col-md-6 mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="notifications" 
                                   name="notifications" 
                                   checked
                                   data-dynamic-update="true">
                            <label class="form-check-label" for="notifications">
                                <i class="bi bi-bell me-1"></i>Activar Notificaciones
                            </label>
                        </div>
                    </div>

                    <!-- Moneda -->
                    <div class="col-md-6 mb-3">
                        <label for="currency" class="form-label">
                            <i class="bi bi-currency-dollar me-1"></i>Moneda
                        </label>
                        <select class="form-select" id="currency" name="currency" data-dynamic-update="true">
                            <option value="ARS">ðŸ‡¦ðŸ‡· Peso Argentino (ARS)</option>
                            <option value="USD">ðŸ‡ºðŸ‡¸ DÃ³lar (USD)</option>
                            <option value="EUR">ðŸ‡ªðŸ‡º Euro (EUR)</option>
                        </select>
                    </div>

                    <!-- Email -->
                    <div class="col-md-6 mb-3">
                        <label for="email" class="form-label">
                            <i class="bi bi-envelope me-1"></i>Email
                        </label>
                        <input type="email" 
                               class="form-control" 
                               id="email" 
                               name="email" 
                               placeholder="usuario@ejemplo.com"
                               data-validator="email"
                               data-dynamic-update="true">
                    </div>

                    <!-- TelÃ©fono -->
                    <div class="col-md-6 mb-3">
                        <label for="phone" class="form-label">
                            <i class="bi bi-phone me-1"></i>TelÃ©fono
                        </label>
                        <input type="tel" 
                               class="form-control" 
                               id="phone" 
                               name="phone" 
                               placeholder="11 1234 5678"
                               data-validator="phone"
                               data-updater="phoneFormatter"
                               data-dynamic-update="true">
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-4">
                    <button type="button" class="btn btn-outline-secondary" onclick="resetPreferences()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Restablecer
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>Guardar Preferencias
                    </button>
                </div>
            </form>
        </section>

        <!-- SimulaciÃ³n de Carrito -->
        <section class="demo-section">
            <h3><i class="bi bi-cart me-2"></i>Simulador de Carrito</h3>
            <p class="text-muted mb-4">Prueba las funcionalidades del carrito con actualizaciÃ³n en tiempo real</p>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary" onclick="addSampleProduct('jarro')">
                            <i class="bi bi-plus-circle me-1"></i>Agregar Jarro
                        </button>
                        <button class="btn btn-primary" onclick="addSampleProduct('cuaderno')">
                            <i class="bi bi-plus-circle me-1"></i>Agregar Cuaderno
                        </button>
                        <button class="btn btn-primary" onclick="addSampleProduct('yerbera')">
                            <i class="bi bi-plus-circle me-1"></i>Agregar Yerbera
                        </button>
                        <button class="btn btn-outline-danger" onclick="clearCart()">
                            <i class="bi bi-trash me-1"></i>Vaciar
                        </button>
                    </div>
                    
                    <div class="cart-preview" id="cartPreview">
                        <!-- Se llena dinÃ¡micamente -->
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-calculator me-1"></i>Resumen
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <span>Items:</span>
                                <span id="cartCount">0</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Total:</span>
                                <span id="cartTotal" class="fw-bold">$0</span>
                            </div>
                            <hr>
                            <button class="btn btn-success w-100" id="checkoutBtn" disabled>
                                <i class="bi bi-credit-card me-1"></i>Finalizar Compra
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Log de Eventos -->
        <section class="demo-section">
            <h3><i class="bi bi-list-ul me-2"></i>Log de Eventos</h3>
            <div class="demo-log" id="eventLog">
                <div class="log-entry log-info">
                    <span class="log-timestamp">[${new Date().toLocaleTimeString()}]</span>
                    Sistema inicializado correctamente
                </div>
            </div>
        </section>

        <!-- Panel de Control del Storage -->
        <section class="demo-section">
            <h3><i class="bi bi-database me-2"></i>Control del Storage</h3>
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-info w-100 mb-2" onclick="exportData()">
                        <i class="bi bi-download me-1"></i>Exportar Datos
                    </button>
                </div>
                <div class="col-md-6">
                    <input type="file" class="form-control mb-2" id="importFile" accept=".json">
                    <button class="btn btn-warning w-100" onclick="importData()">
                        <i class="bi bi-upload me-1"></i>Importar Datos
                    </button>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <button class="btn btn-outline-danger w-100" onclick="clearAllData()">
                        <i class="bi bi-trash me-1"></i>Limpiar Todo
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-outline-info w-100" onclick="showStorageStats()">
                        <i class="bi bi-info-circle me-1"></i>Ver EstadÃ­sticas
                    </button>
                </div>
            </div>
        </section>
    </div>

    <!-- Feedback Global -->
    <div id="globalFeedback" class="update-feedback">
        <!-- Mensajes se muestran aquÃ­ -->
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/storage/StorageManager.js"></script>
    <script src="js/forms/DynamicFormManager.js"></script>

    <script>
        // Variables globales
        let updateInterval;
        let eventCount = 0;

        // InicializaciÃ³n
        document.addEventListener('DOMContentLoaded', function() {
            initializeDemo();
        });

        function initializeDemo() {
            // Configurar eventos personalizados
            setupEventListeners();
            
            // Cargar preferencias guardadas
            loadSavedPreferences();
            
            // Actualizar estadÃ­sticas periÃ³dicamente
            updateStats();
            updateInterval = setInterval(updateStats, 5000);
            
            // Actualizar vista del carrito
            updateCartDisplay();
            
            log('ðŸš€ Demo inicializada correctamente', 'success');
        }

        function setupEventListeners() {
            // Escuchar cambios en formularios
            document.addEventListener('fieldUpdated', (e) => {
                log(`ðŸ“ Campo actualizado: ${e.detail.fieldName} = ${e.detail.value}`, 'info');
                showGlobalFeedback('ðŸ’¾ Cambio guardado automÃ¡ticamente');
            });

            // Escuchar eventos del storage
            Storage.addEventListener('dataSet', (data) => {
                log(`ðŸ’¾ Datos guardados: ${data.key}`, 'success');
            });

            Storage.addEventListener('dataGet', (data) => {
                log(`ðŸ“– Datos obtenidos: ${data.key}`, 'info');
            });

            // Escuchar cambios en el carrito
            document.addEventListener('cartUpdated', () => {
                updateCartDisplay();
                log('ðŸ›’ Carrito actualizado', 'info');
            });
        }

        function loadSavedPreferences() {
            const preferences = QuickStorage.getPreferences();
            
            // Aplicar valores a los campos
            Object.entries(preferences).forEach(([key, value]) => {
                const input = document.getElementById(key);
                if (input) {
                    if (input.type === 'checkbox') {
                        input.checked = value;
                    } else {
                        input.value = value;
                    }
                }
            });

            log('âš™ï¸ Preferencias cargadas', 'success');
        }

        function updateStats() {
            const storageStats = QuickStorage.getStats();
            const formStats = FormManager.getStats();
            const cartCount = QuickStorage.getCarritoCount();

            const stats = [
                {
                    icon: 'ðŸ’¾',
                    value: storageStats.totalKeys,
                    label: 'Claves Almacenadas'
                },
                {
                    icon: 'ðŸ“',
                    value: formStats.formsRegistered,
                    label: 'Formularios Registrados'
                },
                {
                    icon: 'ðŸ›’',
                    value: cartCount,
                    label: 'Items en Carrito'
                },
                {
                    icon: 'ðŸ“Š',
                    value: Math.round(storageStats.storageUsage?.usagePercentage || 0) + '%',
                    label: 'Uso de Storage'
                }
            ];

            const grid = document.getElementById('statsGrid');
            grid.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <span class="stat-value">${stat.icon} ${stat.value}</span>
                    <span class="stat-label">${stat.label}</span>
                </div>
            `).join('');
        }

        function addSampleProduct(type) {
            const products = {
                jarro: {
                    id: 'jarro-' + Date.now(),
                    nombre: 'Jarro Zorrito',
                    precio: 21900,
                    cantidad: 1,
                    imagen: 'pages/jarro1.webp'
                },
                cuaderno: {
                    id: 'cuaderno-' + Date.now(),
                    nombre: 'Cuaderno PatagÃ³nico',
                    precio: 15000,
                    cantidad: 1,
                    imagen: 'pages/cuaderno1.webp'
                },
                yerbera: {
                    id: 'yerbera-' + Date.now(),
                    nombre: 'Yerbera Artesanal',
                    precio: 28500,
                    cantidad: 1,
                    imagen: 'pages/yerbera1.webp'
                }
            };

            const product = products[type];
            if (product) {
                QuickStorage.addToCarrito(product);
                updateCartDisplay();
                showGlobalFeedback(`âœ… ${product.nombre} agregado al carrito`);
                log(`ðŸ›’ Producto agregado: ${product.nombre}`, 'success');
            }
        }

        function updateCartDisplay() {
            const carrito = QuickStorage.getCarrito();
            const preview = document.getElementById('cartPreview');
            const countElement = document.getElementById('cartCount');
            const totalElement = document.getElementById('cartTotal');
            const checkoutBtn = document.getElementById('checkoutBtn');

            if (carrito.length === 0) {
                preview.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-cart-x fs-1"></i>
                        <p class="mb-0">El carrito estÃ¡ vacÃ­o</p>
                    </div>
                `;
            } else {
                preview.innerHTML = carrito.map(item => `
                    <div class="cart-item">
                        <div>
                            <strong>${item.nombre}</strong><br>
                            <small class="text-muted">Cantidad: ${item.cantidad}</small>
                        </div>
                        <div>
                            <span class="fw-bold">$${item.precio.toLocaleString()}</span>
                            <button class="btn btn-sm btn-outline-danger ms-2" 
                                    onclick="removeFromCart('${item.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            const count = carrito.reduce((total, item) => total + item.cantidad, 0);
            const total = carrito.reduce((total, item) => total + (item.precio * item.cantidad), 0);

            countElement.textContent = count;
            totalElement.textContent = '$' + total.toLocaleString();
            checkoutBtn.disabled = count === 0;
        }

        function removeFromCart(productId) {
            QuickStorage.removeFromCarrito(productId);
            updateCartDisplay();
            showGlobalFeedback('ðŸ—‘ï¸ Producto eliminado del carrito');
            log(`ðŸ—‘ï¸ Producto eliminado del carrito: ${productId}`, 'warning');
        }

        function clearCart() {
            QuickStorage.clearCarrito();
            updateCartDisplay();
            showGlobalFeedback('ðŸ§¹ Carrito vaciado');
            log('ðŸ§¹ Carrito vaciado completamente', 'warning');
        }

        function resetPreferences() {
            const defaultPrefs = {
                backgroundColor: '#f4f1ee',
                theme: 'light',
                notifications: true,
                currency: 'ARS',
                email: '',
                phone: ''
            };

            QuickStorage.setPreferences(defaultPrefs);
            loadSavedPreferences();
            
            // Aplicar tema y color
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            document.body.style.backgroundColor = defaultPrefs.backgroundColor;
            
            showGlobalFeedback('ðŸ”„ Preferencias restablecidas');
            log('ðŸ”„ Preferencias restablecidas a valores por defecto', 'info');
        }

        function exportData() {
            const data = QuickStorage.exportAll();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `patagonia-backup-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showGlobalFeedback('ðŸ“¥ Datos exportados correctamente');
            log('ðŸ“¥ Datos exportados a archivo JSON', 'success');
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showGlobalFeedback('âš ï¸ Selecciona un archivo para importar', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const result = QuickStorage.importAll(data);
                    
                    showGlobalFeedback(`ðŸ“¤ ${result.imported} elementos importados`);
                    log(`ðŸ“¤ ImportaciÃ³n completada: ${result.imported} exitosos, ${result.errors} errores`, 'success');
                    
                    // Recargar vista
                    loadSavedPreferences();
                    updateCartDisplay();
                    updateStats();
                    
                } catch (error) {
                    showGlobalFeedback('âŒ Error al importar archivo', 'error');
                    log(`âŒ Error en importaciÃ³n: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('Â¿EstÃ¡s seguro de que quieres eliminar todos los datos?')) {
                Storage.clear();
                
                // Resetear vista
                loadSavedPreferences();
                updateCartDisplay();
                updateStats();
                
                showGlobalFeedback('ðŸ§¹ Todos los datos eliminados');
                log('ðŸ§¹ Todos los datos del storage han sido eliminados', 'warning');
            }
        }

        function showStorageStats() {
            const stats = Storage.getStats();
            const usage = stats.storageUsage;
            
            let message = `ðŸ“Š EstadÃ­sticas del Storage:\n\n`;
            message += `ðŸ—‚ï¸ Claves totales: ${stats.totalKeys}\n`;
            message += `ðŸ’¾ Espacio usado: ${usage ? Math.round(usage.usagePercentage) + '%' : 'N/A'}\n`;
            message += `ðŸ“¦ Namespace: ${stats.namespace}\n`;
            message += `ðŸ”¢ VersiÃ³n: ${stats.version}\n`;
            message += `ðŸ”§ Esquemas disponibles: ${stats.schemas.join(', ')}`;
            
            alert(message);
        }

        function showGlobalFeedback(message, type = 'success') {
            const feedback = document.getElementById('globalFeedback');
            const colors = {
                success: '#28a745',
                warning: '#ffc107',
                error: '#dc3545',
                info: '#17a2b8'
            };

            feedback.style.backgroundColor = colors[type] || colors.success;
            feedback.textContent = message;
            feedback.classList.add('show');

            setTimeout(() => {
                feedback.classList.remove('show');
            }, 3000);
        }

        function log(message, type = 'info') {
            const logElement = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
            
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
            
            eventCount++;
            
            // Mantener solo los Ãºltimos 50 logs
            while (logElement.children.length > 50) {
                logElement.removeChild(logElement.firstChild);
            }
        }

        // Cleanup cuando se cierra la pÃ¡gina
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>